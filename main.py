from langchain_openai import OpenAIEmbeddings
from langchain_community.vectorstores import FAISS
import os
import time
import sqlite3
from dotenv import load_dotenv
from openai import OpenAI
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, ContextTypes, filters
from telegram.constants import ChatAction
import json

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ---

# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–∑ —Ñ–∞–π–ª–∞ .env
load_dotenv()

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–ª—é—á–µ–π –∏ —Ç–æ–∫–µ–Ω–æ–≤
DB_PATH = os.getenv("DB_PATH", "chatbot.db")
TG = os.getenv("TELEGRAM_BOT_TOKEN")
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
MODEL = os.getenv("OPENAI_MODEL", "gpt-4o-mini")

# –ü—É—Ç—å –∫ —Å–æ–∑–¥–∞–Ω–Ω–æ–π –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
DB_FAISS_PATH = "faiss_vector_db"
# –ú–æ–¥–µ–ª—å –¥–ª—è —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤ (–¥–æ–ª–∂–Ω–∞ —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å index_db.py)
EMBEDDING_MODEL = "text-embedding-3-small"
# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –∏–∑–≤–ª–µ–∫–∞–µ–º—ã—Ö –∏–∑ –ë–î –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
RETRIEVER_K = 3
# –ö–û–ù–°–¢–ê–ù–¢–ê: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏–∏ –¥–ª—è LLM
HISTORY_LIMIT = 10

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
if not OPENAI_API_KEY or not TG:
    raise RuntimeError("–ù—É–∂–Ω—ã OPENAI_API_KEY –∏ TELEGRAM_BOT_TOKEN –≤ .env")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ OpenAI
client = OpenAI(api_key=OPENAI_API_KEY)

# --- –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è LLM (–ë—É—Ö–≥–∞–ª—Ç–µ—Ä –¥–ª—è –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞) ---

SYSTEM_PROMPT = (
    "–¢—ã ‚Äî –≤—ã—Å–æ–∫–æ–∫–≤–∞–ª–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–æ–º—É –∏ –Ω–∞–ª–æ–≥–æ–≤–æ–º—É —É—á–µ—Ç—É –≤ –†–µ—Å–ø—É–±–ª–∏–∫–µ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω (–†–ö). "
    "–¢–≤–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è ‚Äî —Å–ª—É–∂–∏—Ç—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—ã–º —è–¥—Ä–æ–º Telegram-–±–æ—Ç–∞-–±—É—Ö–≥–∞–ª—Ç–µ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –ø–æ–º–æ–≥–∞—Ç—å "
    "–∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º –ø—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—è–º (–ò–ü) –∏ –º–∞–ª–æ–º—É –±–∏–∑–Ω–µ—Å—É –≤ –†–ö. "
    "–í—Å–µ –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã —Å—Ç—Ä–æ–≥–æ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω–æ–º—É –ù–∞–ª–æ–≥–æ–≤–æ–º—É –∫–æ–¥–µ–∫—Å—É –†–ö. "
    "–£—á–∏—Ç—ã–≤–∞–π –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ (–ò–ü, –û–£–†, —É–ø—Ä–æ—â–µ–Ω–∫–∞, –ö–ì–î, –≠–°–§, –ö–ö–ú) –∏ –∏—Å–ø–æ–ª—å–∑—É–π KZT. "
    "–û—Ç–≤–µ—á–∞–π –∫—Ä–∞—Ç–∫–æ –∏ —Ç–æ—á–Ω–æ, —Å—Å—ã–ª–∞—è—Å—å –Ω–∞ –ù–ö –†–ö. "
    "–¢–≤–æ–π —Ç–æ–Ω: –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π. "
    "–í–∞–∂–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø: –ï—Å–ª–∏ –±–æ—Ç –Ω–µ —É–≤–µ—Ä–µ–Ω –∏–ª–∏ –≤–æ–ø—Ä–æ—Å –∫–∞—Å–∞–µ—Ç—Å—è —Ç–æ–Ω–∫–∏—Ö –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤, "
    "–∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É —Ñ—Ä–∞–∑—É: '–≠—Ç–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –¥–ª—è –≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏. –õ—É—á—à–µ —É—Ç–æ—á–Ω–∏—Ç—å —É –±—É—Ö–≥–∞–ª—Ç–µ—Ä–∞. –ú–æ–≥—É –∑–∞–ø–∏—Å–∞—Ç—å –≤–∞—à –≤–æ–ø—Ä–æ—Å.'"
)

# --- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è RAG ---
print("–ó–∞–≥—Ä—É–∑–∫–∞ RAG-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤...")


# 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥–µ–ª–∏ —ç–º–±–µ–¥–¥–∏–Ω–≥–æ–≤
embeddings = OpenAIEmbeddings(api_key=OPENAI_API_KEY, model=EMBEDDING_MODEL)
# 2. –ó–∞–≥—Ä—É–∑–∫–∞ –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö FAISS
if not os.path.exists(DB_FAISS_PATH):
    raise FileNotFoundError(
        f"–ü–∞–ø–∫–∞ —Å –≤–µ–∫—Ç–æ—Ä–Ω–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö '{DB_FAISS_PATH}' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. "
        "–°–Ω–∞—á–∞–ª–∞ –∑–∞–ø—É—Å—Ç–∏—Ç–µ index_db.py."
    )
# –û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ allow_dangerous_deserialization=True.
# –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å FAISS-—Ö—Ä–∞–Ω–∏–ª–∏—â–∞–º–∏, –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –ª–æ–∫–∞–ª—å–Ω–æ
vector_store = FAISS.load_local(DB_FAISS_PATH, embeddings, allow_dangerous_deserialization=True)
retriever = vector_store.as_retriever(search_kwargs={"k": RETRIEVER_K})
print("RAG-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã.")




# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö SQLite ---

# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
db = sqlite3.connect(DB_PATH, check_same_thread=False)
db.row_factory = sqlite3.Row  # –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –≤–∏–¥–µ —Å–ª–æ–≤–∞—Ä—è

# –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
db.execute("""CREATE TABLE IF NOT EXISTS m(
    id INTEGER PRIMARY KEY AUTOINCREMENT, 
    user_id INTEGER, 
    role TEXT, 
    content TEXT, 
    ts REAL
)""")

# –ù–û–í–ê–Ø –¢–ê–ë–õ–ò–¶–ê: –î–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
db.execute("""CREATE TABLE IF NOT EXISTS context(
    user_id INTEGER PRIMARY KEY,
    company_name TEXT DEFAULT '',
    tax_regime TEXT DEFAULT '',
    other_data TEXT DEFAULT '{}'
)""")
db.commit()


# --- –§—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö ---

def add(uid: int, role: str, text: str):
    """–î–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é."""
    db.execute("INSERT INTO m(user_id, role, content, ts) VALUES(?,?,?,?)",
               (uid, role, text, time.time()))
    db.commit()


# –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–æ–ª—É—á–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏
def get_context(uid: int) -> dict:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–π –∫–æ–º–ø–∞–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    row = db.execute("SELECT * FROM context WHERE user_id=?", (uid,)).fetchone()
    if row:
        return dict(row)
    # –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å, –µ—Å–ª–∏ –µ–µ –Ω–µ—Ç, –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
    db.execute("INSERT OR IGNORE INTO context(user_id) VALUES(?)", (uid,))
    db.commit()
    return {'company_name': '', 'tax_regime': '', 'other_data': '{}'}


# –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±–Ω–æ–≤–ª—è–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ–º–ø–∞–Ω–∏–∏
def update_context(uid: int, company_name: str, tax_regime: str, other_data: dict):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –∏–º—è –∫–æ–º–ø–∞–Ω–∏–∏ –∏ –Ω–∞–ª–æ–≥–æ–≤—ã–π —Ä–µ–∂–∏–º."""
    db.execute("""
        INSERT INTO context (user_id, company_name, tax_regime, other_data)
        VALUES (?, ?, ?, ?)
        ON CONFLICT(user_id) DO UPDATE SET 
            company_name=excluded.company_name, 
            tax_regime=excluded.tax_regime, 
            other_data=excluded.other_data
    """, (uid, company_name, tax_regime, json.dumps(other_data)))
    db.commit()


def clear(uid: int) -> int:
    """–û—á–∏—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ–º–ø–∞–Ω–∏–∏."""
    # 1. –û—á–∏—â–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
    cur = db.execute("DELETE FROM m WHERE user_id=?", (uid,))

    # 2. –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ–º–ø–∞–Ω–∏–∏
    db.execute("UPDATE context SET company_name='', tax_regime='', other_data='{}' WHERE user_id=?", (uid,))

    db.commit()
    return cur.rowcount


def hist(uid: int) -> list[dict]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¥–ª—è API OpenAI,
    –≤–∫–ª—é—á–∞—è —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∫–æ–º–ø–∞–Ω–∏–∏.
    """
    # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ–º–ø–∞–Ω–∏–∏
    ctx = get_context(uid)
    company = ctx.get('company_name', '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞')
    regime = ctx.get('tax_regime', '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')

    # –§–æ—Ä–º–∏—Ä—É–µ–º –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —É—á–µ—Ç–æ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    context_info = (
        f"\n\n[–ö–û–ù–¢–ï–ö–°–¢ –ö–û–ú–ü–ê–ù–ò–ò]: –ö–ª–∏–µ–Ω—Ç –æ–±—Å—É–∂–¥–∞–µ—Ç –∫–æ–º–ø–∞–Ω–∏—é: '{company}'. "
        f"–¢–µ–∫—É—â–∏–π –Ω–∞–ª–æ–≥–æ–≤—ã–π —Ä–µ–∂–∏–º: '{regime}'. "
        "–£—á–∏—Ç—ã–≤–∞–π —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –ø—Ä–∏ –æ—Ç–≤–µ—Ç–∞—Ö. –ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞/–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω', –ø–æ–ø—Ä–æ—Å–∏ –∫–ª–∏–µ–Ω—Ç–∞ —É—Ç–æ—á–Ω–∏—Ç—å."
    )

    system_message = {"role": "system", "content": SYSTEM_PROMPT + context_info}

    # –í—ã–±–∏—Ä–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
    rows = db.execute(
        "SELECT role, content FROM m WHERE user_id=? ORDER BY ts DESC LIMIT ?",
        (uid, HISTORY_LIMIT)
    ).fetchall()

    history_messages = [{"role": r, "content": c} for r, c in reversed(rows)]

    return [system_message] + history_messages


# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–æ–º–∞–Ω–¥ Telegram ---

async def start_cmd(update: Update, c: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start."""
    text = (
        "**–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –±—É—Ö–≥–∞–ª—Ç–µ—Ä—Å–∫–∏–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç.**\n\n"
        "‚úÖ –ú–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º —Å –Ω–∞–ª–æ–≥–∞–º–∏, –æ—Ç—á—ë—Ç–Ω–æ—Å—Ç—å—é, —Å—Ä–æ–∫–∞–º–∏ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏.\n"
        "üíº –ï—Å–ª–∏ –≤—ã –≤–µ–¥—ë—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–æ–º–ø–∞–Ω–∏–π, –ø—Ä–æ—Å—Ç–æ —É–∫–∞–∂–∏—Ç–µ, –ø—Ä–æ –∫–∞–∫—É—é —Ä–µ—á—å "
        '(–Ω–∞–ø—Ä–∏–º–µ—Ä: "–Ø –≤–ª–∞–¥–µ–ª–µ—Ü –∫–æ–º–ø–∞–Ω–∏–∏ –¢–û–û \"–ö–æ–º–ø–∞–Ω–∏—è\" –Ω–∞ —É–ø—Ä–æ—â–µ–Ω–∫–µ").\n\n'
        "**–ö–æ–º–∞–Ω–¥—ã:**\n"
       "‚Äì /companies ‚ÑπÔ∏è ‚Äî –ü–æ–∫–∞–∑–∞—Ç—å —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ–º–ø–∞–Ω–∏–∏.\n"
        "‚Äì /reset üóëÔ∏è ‚Äî –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –¥–∏–∞–ª–æ–≥ –∏ —Å–±—Ä–æ—Å–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é.\n"
        "‚Äì /stop üõë ‚Äî –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é."
    )
    await update.message.reply_markdown(text)


# –ù–û–í–ê–Ø –ö–û–ú–ê–ù–î–ê: /companies
async def companies_cmd(update: Update, c: ContextTypes.DEFAULT_TYPE):
    """–û–±—ä—è—Å–Ω—è–µ—Ç —Ä–∞–±–æ—Ç—É —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∫–æ–º–ø–∞–Ω–∏–π."""
    uid = update.effective_user.id
    ctx = get_context(uid)
    company = ctx.get('company_name', '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞')
    regime = ctx.get('tax_regime', '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω')

    text = (
        "üíº **–†–∞–±–æ—Ç–∞ —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∫–æ–º–ø–∞–Ω–∏—è–º–∏**\n"
        "–Ø —É–º–µ—é –∑–∞–ø–æ–º–∏–Ω–∞—Ç—å, –∫–∞–∫—É—é –∫–æ–º–ø–∞–Ω–∏—é –≤—ã –æ–±—Å—É–∂–¥–∞–µ—Ç–µ, –∏ —É—á–∏—Ç—ã–≤–∞—Ç—å –µ–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–∞–ª–æ–≥–æ–≤—ã–π —Ä–µ–∂–∏–º) –≤ –æ—Ç–≤–µ—Ç–∞—Ö.\n\n"
        "**–¢–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç:**\n"
        f"**–ö–æ–º–ø–∞–Ω–∏—è:** {company if company else '‚ùå –ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞'}\n"
        f"**–†–µ–∂–∏–º:** {regime if regime else '‚ùì –ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}\n\n"
        "**–ö–∞–∫ —Å–º–µ–Ω–∏—Ç—å –∫–æ–º–ø–∞–Ω–∏—é?**\n"
        "–ü—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è, –Ω–∞–ø—Ä–∏–º–µ—Ä: '–¢–µ–ø–µ—Ä—å —Ä–µ—á—å –ø—Ä–æ –¢–û–û '–ö–æ–º–ø–∞–Ω–∏—è' –Ω–∞ –û–£–†'.\n"
        "**–î–ª—è —Å–±—Ä–æ—Å–∞** –≤—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /reset."
    )
    await update.message.reply_markdown(text)


async def reset_cmd(update: Update, c: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /reset - –æ—á–∏—â–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—é –ò —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç –∫–æ–º–ø–∞–Ω–∏—é."""
    n = clear(update.effective_user.id)
    await update.message.reply_text(
        f"‚úÖ –î–∏–∞–ª–æ–≥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—â–µ–Ω (—É–¥–∞–ª–µ–Ω–æ: {n} —Å–æ–æ–±—â–µ–Ω–∏–π).\n"
        "–ö–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ–º–ø–∞–Ω–∏–∏ —Å–±—Ä–æ—à–µ–Ω. –ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, —É–∫–∞–∂–∏—Ç–µ –∫–æ–º–ø–∞–Ω–∏—é —Å–Ω–æ–≤–∞."
    )


async def stop_cmd(update: Update, c: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /stop - –∑–∞–≤–µ—Ä—à–∞–µ—Ç —Å–µ—Å—Å–∏—é (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Å—Ç–æ—Ä–∏—é)."""
    ctx = get_context(update.effective_user.id)
    company = ctx.get('company_name', '–≤–∞—à–µ–π –∫–æ–º–ø–∞–Ω–∏–∏')

    await update.message.reply_text(
        f"–°–µ—Å—Å–∏—è –ø–æ {company} –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ò—Å—Ç–æ—Ä–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞. –î–æ —Å–≤—è–∑–∏!"
    )


# --- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π ---

async def reply_text(u: Update, c: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±—ã—á–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π."""

    if not u.message or not u.message.text:
        return

    uid = u.effective_user.id
    text = u.message.text.strip()

    if not text:
        return

    # 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "–ø–µ—á–∞—Ç–∞–µ—Ç..."
    await c.bot.send_chat_action(chat_id=u.effective_chat.id, action=ChatAction.TYPING)

    # 2. –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∏—Å—Ç–æ—Ä–∏—é –î–û –≤—ã–∑–æ–≤–∞ LLM, —á—Ç–æ–±—ã –æ–Ω –º–æ–≥
    #    –µ–≥–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç.
    add(uid, "user", text)

    try:
        # --- RAG-–ü–ê–ô–ü–õ–ê–ô–ù ---

        # 1. –ü–æ–∏—Å–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –ù–∞–ª–æ–≥–æ–≤–æ–º –∫–æ–¥–µ–∫—Å–µ
        retrieved_docs = retriever.invoke(text)

        # 2. –û–±—ä–µ–¥–∏–Ω—è–µ–º –Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –≤ –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É
        context_docs = "\n---\n".join([doc.page_content for doc in retrieved_docs])

        # 3. –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ SQLite
        history_with_context = hist(uid)

        # 4. –§–æ—Ä–º–∏—Ä—É–µ–º RAG-–∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è LLM
        rag_context_info = (
            f"\n\n[–ù–ê–ô–î–ï–ù–ù–´–ô –ö–û–ù–¢–ï–ö–°–¢ –ò–ó –ù–ö –†–ö]: –ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –æ—Ç–≤–µ—Ç–∞, —Ü–∏—Ç–∏—Ä—É—è, –µ—Å–ª–∏ —ç—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ. "
            f"–ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç —Ç–≤–æ–∏–º –∑–Ω–∞–Ω–∏—è–º, –æ—Ç–¥–∞–π –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ —ç—Ç–æ–π:\n\n{context_docs}"
        )

        # 5. –ò—Å–ø–æ–ª—å–∑—É–µ–º —É—Å–∏–ª–µ–Ω–Ω—ã–π analysis_prompt (—Å –º–µ—Ç–∫–æ–π [UPDATE:...])
        analysis_prompt = (
            "–ü–†–û–ê–ù–ê–õ–ò–ó–ò–†–£–ô–¢–ï —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –ï—Å–ª–∏ –æ–Ω–æ —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ–≤–æ–µ –∏–º—è –∫–æ–º–ø–∞–Ω–∏–∏/–ò–ü, "
            "–Ω–∞–ª–æ–≥–æ–≤—ã–π —Ä–µ–∂–∏–º ('—É–ø—Ä–æ—â–µ–Ω–∫–∞', '–û–£–†', '—Ä–æ–∑–Ω–∏—á–Ω—ã–π –Ω–∞–ª–æ–≥') –ò–õ–ò –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –∫–ª—é—á–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, '–¥–æ—Ö–æ–¥: 20 –º–ª–Ω'), "
            "–í–´–í–ï–î–ò–¢–ï –≤ —Å–∞–º–æ–º –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞, –Ω–æ –ø–µ—Ä–µ–¥ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Ç–æ—á–∫–æ–π, **–û–î–ù–£** —Å—Ç—Ä–æ–∫—É "
            "–≤ —Ñ–æ—Ä–º–∞—Ç–µ: [UPDATE: CompanyName|TaxRegime|OtherData(JSON-–æ–±—ä–µ–∫—Ç)]. "
            "–ï—Å–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç, –Ω–µ –≤—ã–≤–æ–¥–∏—Ç–µ —ç—Ç—É —Å—Ç—Ä–æ–∫—É. "
            "–ï–°–õ–ò –ù–ê–ó–í–ê–ù–û –ù–û–í–û–ï –ò–ú–Ø –ö–û–ú–ü–ê–ù–ò–ò, –í–´ –î–û–õ–ñ–ù–´ –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –í–´–í–ï–°–¢–ò –≠–¢–£ –ú–ï–¢–ö–£ [UPDATE...]! "
            "–ü—Ä–∏–º–µ—Ä: '–ò–ü –°–µ–π—Ç–æ–≤|–û–£–†|{}' –∏–ª–∏ '–¢–û–û ABC Group|—É–ø—Ä–æ—â–µ–Ω–∫–∞|{\"–¥–æ—Ö–æ–¥_–∫–≤–∞—Ä—Ç–∞–ª\": \"20000000\"}'"
        )

        # 6. –°–æ–±–∏—Ä–∞–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–∏—Å—Ç–µ–º–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        # history_with_context[0]['content'] ‚Äî —ç—Ç–æ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç + –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ–º–ø–∞–Ω–∏–∏ –∏–∑ SQLite
        final_system_prompt = history_with_context[0]['content'] + rag_context_info + analysis_prompt

        messages_for_llm = [
                               {"role": "system", "content": final_system_prompt}
                           ] + history_with_context[1:]

        # 7. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∫ OpenAI
        r = client.chat.completions.create(model=MODEL, messages=messages_for_llm)

        ans = (r.choices[0].message.content or "").strip()

        # --- –ö–û–ù–ï–¶ RAG-–ü–ê–ô–ü–õ–ê–ô–ù–ê ---

        # –ü–∞—Ä—Å–∏–Ω–≥ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

        # –ò—â–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é –º–µ—Ç–∫—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞
        update_tag = None
        if ans.endswith(']'):
            try:
                tag_start = ans.rindex('[UPDATE:')
                update_tag = ans[tag_start:]
                # –£–±–∏—Ä–∞–µ–º –º–µ—Ç–∫—É –∏–∑ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
                ans = ans[:tag_start].strip()
            except ValueError:
                pass  # –ú–µ—Ç–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞

        if update_tag:
            try:
                # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–µ–∂–¥—É [UPDATE: –∏ ]
                data_string = update_tag.strip('[UPDATE:').strip(']').strip()
                company_data = data_string.split('|')

                # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç
                current_ctx = get_context(uid)
                current_other_data = json.loads(current_ctx.get('other_data', '{}'))

                # –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô –ü–ê–†–°–ò–ù–ì: –î–æ–±–∞–≤–ª–µ–Ω .replace('"', '') –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –æ—Ç –∫–∞–≤—ã—á–µ–∫ LLM
                new_company = company_data[0].strip().replace('"', '') if len(company_data) > 0 else current_ctx.get(
                    'company_name', '')
                new_regime = company_data[1].strip().replace('"', '') if len(company_data) > 1 else current_ctx.get(
                    'tax_regime', '')

                # –û–±–Ω–æ–≤–ª—è–µ–º 'other_data'
                if len(company_data) > 2:
                    try:
                        new_other_data = json.loads(company_data[2].strip())
                        # –û–±—ä–µ–¥–∏–Ω—è–µ–º —Å—Ç–∞—Ä—ã–µ –∏ –Ω–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ, –µ—Å–ª–∏ —ç—Ç–æ –æ–±—ä–µ–∫—Ç
                        current_other_data.update(new_other_data)
                    except json.JSONDecodeError:
                        print("–û—à–∏–±–∫–∞ –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è JSON –≤ OtherData")

                # –û–±–Ω–æ–≤–ª—è–µ–º –ë–î
                update_context(uid, new_company, new_regime, current_other_data)

            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞: {e}")
                pass  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫—É –ø–∞—Ä—Å–∏–Ω–≥–∞, –Ω–æ –ª–æ–≥–∏—Ä—É–µ–º –µ–µ

        # --- –ö–û–ù–ï–¶ –ü–ê–†–°–ò–ù–ì–ê ---





    except Exception as e:
        # 6. –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–∫–∏
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ OpenAI: {e}")
        ans = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∞. –ü—Ä–æ–±–ª–µ–º–∞ —Å API. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑."

        # 7. –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é (—É–∂–µ –±–µ–∑ –º–µ—Ç–∫–∏ [UPDATE...])
    add(uid, "assistant", ans)

    # 8. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await u.message.reply_text(ans)


# --- –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ –±–æ—Ç–∞ ---

def main():
    """–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–æ—Ç–∞."""
    # –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    app = Application.builder().token(TG).build()

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∫–æ–º–∞–Ω–¥
    app.add_handler(CommandHandler("start", start_cmd))
    app.add_handler(CommandHandler("reset", reset_cmd))
    app.add_handler(CommandHandler("stop", stop_cmd))
    app.add_handler(CommandHandler("companies", companies_cmd))  # –ù–û–í–ê–Ø –ö–û–ú–ê–ù–î–ê

    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, reply_text))

    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    print("–ë–æ—Ç –∑–∞–ø—É—â–µ–Ω...")
    app.run_polling(close_loop=False)


if __name__ == '__main__':
    main()